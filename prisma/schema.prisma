generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int            @id @default(autoincrement())
  name               String?
  email              String         @unique
  username           String         @unique
  password           String
  role               String         @default("user")
  createdAt          DateTime       @default(now())
  hostel             String?
  phone              String?
  avatar             String?

  // OTP Fields for Password Reset
  resetOTP           String?
  resetOTPExpiry     DateTime?

  // Payment & Trust Score Fields
  upiId              String?
  qrCode             String?        // Path to QR image
  failedPaymentCount Int            @default(0)
  blacklistUntil     DateTime?

  // Verified Student Status
  isVerifiedStudent  Boolean        @default(false)

  // Relations
  listings           Listing[]      @relation("UserListings")
  orders             Order[]        @relation("UserOrders")
  bids               Bid[]          @relation("UserBids")
  notifications      Notification[] @relation("UserNotifications")
  reviews            Review[]       @relation("UserReviews")
  groupOrdersCreated GroupOrder[]   @relation("CreatorGroupOrders")
  groupOrderItems    GroupOrderItem[] @relation("UserGroupOrderItems")
  offers             Offer[]        @relation("UserOffers")
  watchlist          Listing[]      @relation("UserWatchlist")
  sentMessages       Message[]      @relation("SentMessages")
  receivedMessages   Message[]      @relation("ReceivedMessages")
  reportsMade        Report[]       @relation("ReportsMade")
  reportsReceived    Report[]       @relation("ReportsReceived")
}

model VerificationCode {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Listing {
  id           Int         @id @default(autoincrement())
  title        String
  description  String?
  category     String
  condition    String?
  mrp          Int
  price        Int
  negotiable   Boolean     @default(false)
  isAuction    Boolean     @default(false)
  auctionFrom  Int?
  auctionTo    DateTime?
  allowNegBid  Boolean     @default(false)
  imagePath    String?
  ownerId      Int
  status       String      @default("active") // active, sold, deleted
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @default(now()) @updatedAt
  expiryDate   DateTime?
  autoSell     Boolean     @default(true)
  
  // Payment Methods
  paymentMethods String[]    @default(["CASH"]) // ["UPI", "CASH"]

  owner        User        @relation("UserListings", fields: [ownerId], references: [id])
  bids         Bid[]       @relation("ListingBids")
  offers       Offer[]     @relation("ListingOffers")
  orderItems   OrderItem[] @relation("ListingOrderItems")
  reviews      Review[]    @relation("ListingReviews")
  favoritedBy  User[]      @relation("UserWatchlist")
}

model Bid {
  id        Int      @id @default(autoincrement())
  bidderId  Int
  listingId Int
  amount    Int
  createdAt DateTime @default(now())

  bidder    User     @relation("UserBids", fields: [bidderId], references: [id])
  listing   Listing  @relation("ListingBids", fields: [listingId], references: [id])
}

model Order {
  id                Int         @id @default(autoincrement())
  userId            Int
  totalAmount       Int         @default(0)
  status            String      @default("PENDING")
  paymentStatus     String      @default("PENDING")
  trackingId        String?     @unique
  deliveryStatus    String      @default("PENDING")
  
  paymentMethod     String?
  paymentComment    String?
  paymentScreenshot String?

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @default(now()) @updatedAt

  user              User        @relation("UserOrders", fields: [userId], references: [id])
  items             OrderItem[] @relation("OrderItems")
  
  groupOrderId      Int?
  groupOrder        GroupOrder? @relation("GroupOrderOrders", fields: [groupOrderId], references: [id])
  
  reports           Report[]    @relation("OrderReports")
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  listingId Int
  quantity  Int     @default(1)
  price     Int

  order     Order   @relation("OrderItems", fields: [orderId], references: [id])
  listing   Listing @relation("ListingOrderItems", fields: [listingId], references: [id])
}

model GroupOrder {
  id           Int              @id @default(autoincrement())
  platform     String
  title        String
  description  String?
  cutoff       DateTime
  creatorId    Int
  status       String           @default("open")
  createdAt    DateTime         @default(now())
  deliveryFee  Int              @default(0)

  // Payment Methods
  paymentMethods String[]       @default(["CASH"]) // ["UPI", "CASH"]

  creator      User             @relation("CreatorGroupOrders", fields: [creatorId], references: [id])
  participants GroupOrderItem[] @relation("GroupOrderParticipants")
  orders       Order[]          @relation("GroupOrderOrders")
}

model GroupOrderItem {
  id           Int        @id @default(autoincrement())
  groupOrderId Int
  userId       Int
  itemName     String
  amount       Int
  quantity     Int        @default(1)

  user         User       @relation("UserGroupOrderItems", fields: [userId], references: [id])
  groupOrder   GroupOrder @relation("GroupOrderParticipants", fields: [groupOrderId], references: [id])
}

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int
  listingId Int
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  user      User     @relation("UserReviews", fields: [userId], references: [id])
  listing   Listing  @relation("ListingReviews", fields: [listingId], references: [id])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  body      String
  type      String   @default("general")
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user      User     @relation("UserNotifications", fields: [userId], references: [id])
}

model Offer {
  id        Int      @id @default(autoincrement())
  listingId Int
  userId    Int
  amount    Int
  status    String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt DateTime @default(now())

  listing   Listing  @relation("ListingOffers", fields: [listingId], references: [id])
  bidder    User     @relation("UserOffers", fields: [userId], references: [id])
}

model Message {
  id        Int      @id @default(autoincrement())
  senderId  Int
  receiverId Int
  content   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  sender    User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver  User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
}

model Report {
  id          Int      @id @default(autoincrement())
  reporterId  Int
  reportedId  Int
  orderId     Int
  reason      String
  status      String   @default("PENDING") // PENDING, RESOLVED_APPROVE, RESOLVED_REJECT
  adminComment String?
  createdAt   DateTime @default(now())

  reporter    User     @relation("ReportsMade", fields: [reporterId], references: [id])
  reported    User     @relation("ReportsReceived", fields: [reportedId], references: [id])
  order       Order    @relation("OrderReports", fields: [orderId], references: [id])
}