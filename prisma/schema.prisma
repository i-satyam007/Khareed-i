generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int            @id @default(autoincrement())
  name               String?
  email              String         @unique
  username           String         @unique
  password           String
  role               String         @default("user")
  createdAt          DateTime       @default(now())
  hostel             String?
  phone              String?
  avatar             String?

  // âœ… ADDED: OTP Fields for Password Reset
  resetOTP           String?
  resetOTPExpiry     DateTime?

  // Relations
  listings           Listing[]      @relation("UserListings")
  orders             Order[]        @relation("UserOrders")
  bids               Bid[]          @relation("UserBids")
  notifications      Notification[] @relation("UserNotifications")
  reviews            Review[]       @relation("UserReviews")
  groupOrdersCreated GroupOrder[]   @relation("CreatorGroupOrders")
  groupOrderItems    GroupOrderItem[] @relation("UserGroupOrderItems")
}

model Listing {
  id           Int         @id @default(autoincrement())
  title        String
  description  String?
  category     String
  condition    String?
  mrp          Int
  price        Int
  negotiable   Boolean     @default(false)
  isAuction    Boolean     @default(false)
  auctionFrom  Int?
  auctionTo    DateTime?
  allowNegBid  Boolean     @default(false)
  imagePath    String?
  ownerId      Int
  createdAt    DateTime    @default(now())

  owner        User        @relation("UserListings", fields: [ownerId], references: [id])
  bids         Bid[]       @relation("ListingBids")
  orderItems   OrderItem[] @relation("ListingOrderItems")
  reviews      Review[]    @relation("ListingReviews")
}

model Bid {
  id        Int      @id @default(autoincrement())
  bidderId  Int
  listingId Int
  amount    Int
  createdAt DateTime @default(now())

  bidder    User     @relation("UserBids", fields: [bidderId], references: [id])
  listing   Listing  @relation("ListingBids", fields: [listingId], references: [id])
}

model Order {
  id           Int         @id @default(autoincrement())
  userId       Int
  amount       Int
  status       String      @default("pending")
  createdAt    DateTime    @default(now())
  groupOrderId Int?

  user         User        @relation("UserOrders", fields: [userId], references: [id])
  items        OrderItem[] @relation("OrderItems")
  groupOrder   GroupOrder? @relation("GroupOrderOrders", fields: [groupOrderId], references: [id])
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  listingId Int
  price     Int
  quantity  Int     @default(1)

  listing   Listing @relation("ListingOrderItems", fields: [listingId], references: [id])
  order     Order   @relation("OrderItems", fields: [orderId], references: [id])
}

model GroupOrder {
  id           Int              @id @default(autoincrement())
  platform     String
  title        String
  description  String?
  cutoff       DateTime
  creatorId    Int
  status       String           @default("open")
  createdAt    DateTime         @default(now())

  creator      User             @relation("CreatorGroupOrders", fields: [creatorId], references: [id])
  participants GroupOrderItem[] @relation("GroupOrderParticipants")
  orders       Order[]          @relation("GroupOrderOrders")
}

model GroupOrderItem {
  id           Int        @id @default(autoincrement())
  groupOrderId Int
  userId       Int
  itemName     String
  amount       Int
  quantity     Int        @default(1)

  user         User       @relation("UserGroupOrderItems", fields: [userId], references: [id])
  groupOrder   GroupOrder @relation("GroupOrderParticipants", fields: [groupOrderId], references: [id])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  body      String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation("UserNotifications", fields: [userId], references: [id])
}

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int
  listingId Int
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  user      User     @relation("UserReviews", fields: [userId], references: [id])
  listing   Listing  @relation("ListingReviews", fields: [listingId], references: [id])
}